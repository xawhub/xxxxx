if (typeof (SiebelAppFacade.TMOBillingProfilesTogglePM) === "undefined") {
  SiebelJS.Namespace("SiebelAppFacade.TMOBillingProfilesTogglePM");

  define("siebel/custom/TMOBillingProfilesTogglePM", ["siebel/pmodel"], function () {

    SiebelAppFacade.TMOBillingProfilesTogglePM = (function () {

      function TMOBillingProfilesTogglePM(pm) {
        SiebelAppFacade.TMOBillingProfilesTogglePM.superclass.constructor.apply(this, arguments);
      }

      SiebelJS.Extend(TMOBillingProfilesTogglePM, SiebelAppFacade.PresentationModel);

      TMOBillingProfilesTogglePM.prototype.Init = function () {
        SiebelAppFacade.TMOBillingProfilesTogglePM.superclass.Init.apply(this, arguments);
        var self = this;

        // Właściwość, którą PR będzie czytać
        this.SetProperty("HasProfile", false);

        // Zainicjuj i zarejestruj handler zmian rekordu
        try {
          var bc = this.Get("GetBusComp");
          if (bc) {
            // Aktualne ustawienie
            this.UpdateHasProfile(bc);

            // React to record change / show selection
            // Use framework hook: ShowSelection (sa wywoływane przez applet)
            this.AddMethod("ShowSelection", function () {
              self.UpdateHasProfile(bc);
              // powiadom PR/renderer
              self.ExecuteMethod("Refresh");
            }, { sequence: false, scope: this });
          }
        } catch (e) {
          SiebelJS.Log("TMOBillingProfilesTogglePM.Init error: " + e.toString());
        }
      };

      TMOBillingProfilesTogglePM.prototype.UpdateHasProfile = function (bc) {
        try {
          if (!bc) return;
          var val = bc.GetFieldValue("TMO Profile Id");
          this.SetProperty("HasProfile", !!val && val !== "");
        } catch (e) {
          SiebelJS.Log("TMOBillingProfilesTogglePM.UpdateHasProfile error: " + e.toString());
        }
      };

      return TMOBillingProfilesTogglePM;
    })();

    return "SiebelAppFacade.TMOBillingProfilesTogglePM";
  });
}


if (typeof (SiebelAppFacade.TMOBillingProfilesTogglePR) === "undefined") {
  SiebelJS.Namespace("SiebelAppFacade.TMOBillingProfilesTogglePR");

  define("siebel/custom/TMOBillingProfilesTogglePR", ["siebel/phyrenderer"], function () {

    SiebelAppFacade.TMOBillingProfilesTogglePR = (function () {

      function TMOBillingProfilesTogglePR(pm) {
        SiebelAppFacade.TMOBillingProfilesTogglePR.superclass.constructor.apply(this, arguments);
      }

      SiebelJS.Extend(TMOBillingProfilesTogglePR, SiebelAppFacade.PhysicalRenderer);

      TMOBillingProfilesTogglePR.prototype.BindData = function () {
        try {
          SiebelAppFacade.TMOBillingProfilesTogglePR.superclass.BindData.apply(this, arguments);
          this.ToggleApplets();
        } catch (e) {
          SiebelJS.Log("TMOBillingProfilesTogglePR.BindData error: " + e.toString());
        }
      };

      TMOBillingProfilesTogglePR.prototype.BindEvents = function () {
        try {
          SiebelAppFacade.TMOBillingProfilesTogglePR.superclass.BindEvents.apply(this, arguments);
          var self = this;
          var pm = this.GetPM();
          // Listen to "Refresh" method triggered by PM
          pm.AttachEventHandler("Refresh", function () {
            self.ToggleApplets();
          });
        } catch (e) {
          SiebelJS.Log("TMOBillingProfilesTogglePR.BindEvents error: " + e.toString());
        }
      };

      TMOBillingProfilesTogglePR.prototype.ToggleApplets = function () {
        try {
          var pm = this.GetPM();
          var hasProfile = false;
          try { hasProfile = !!pm.Get("HasProfile"); } catch (e) { hasProfile = false; }

          var view = SiebelApp.S_App.GetActiveView();
          if (!view) return;

          // Dopasuj nazwy appletów do swoich
          var bcApplet = view.GetApplet("TMO Billing Profiles Applet");
          var vbcApplet = view.GetApplet("TMO VBC Billing Profiles Applet");

          // If applets not present, nothing to do
          if (!bcApplet && !vbcApplet) return;

          // Ustaw Visible property na PM docelowych appletów (bez dotykania DOM)
          try {
            if (bcApplet && bcApplet.GetPM()) bcApplet.GetPM().SetProperty("Visible", hasProfile ? false : true);
          } catch (e) { SiebelJS.Log("Error setting BC applet Visible: " + e.toString()); }

          try {
            if (vbcApplet && vbcApplet.GetPM()) vbcApplet.GetPM().SetProperty("Visible", hasProfile ? true : false);
          } catch (e) { SiebelJS.Log("Error setting VBC applet Visible: " + e.toString()); }

        } catch (e) {
          SiebelJS.Log("TMOBillingProfilesTogglePR.ToggleApplets error: " + e.toString());
        }
      };

      return TMOBillingProfilesTogglePR;
    })();

    return "SiebelAppFacade.TMOBillingProfilesTogglePR";
  });
}

